<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>EPIC Controller Dashboard</title>

<style>
  :root {
    --bg: #f9fafb; --fg: #111827; --muted: #6b7280;
    --green:#10b981; --green-100:#d1fae5;
    --red:#ef4444; --red-100:#fee2e2;
    --gray:#9ca3af; --gray-100:#f3f4f6;
    --card:#ffffff; --border:#e5e7eb;
    --blue:#2563eb; --blue-100:#dbeafe;
  }
  * { box-sizing: border-box; }
  body {
    margin: 24px; background: var(--bg); color: var(--fg);
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  }

  /* Header */
  header { margin-bottom: 18px; display:flex; align-items:center; justify-content:space-between; gap:12px; }
  h1 { font-size: 20px; margin: 0; }
  .legend { display: flex; gap: 10px; flex-wrap: wrap; }
  .dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 6px; vertical-align: -1px; }
  .lg { display: flex; align-items: center; gap: 6px; color: var(--muted); font-size: 12px; }
  .dot-green{ background:var(--green) } .dot-red{ background:var(--red) } .dot-gray{ background:var(--gray) }

  /* Sync status badge */
  .sync {
    display:flex; align-items:center; gap:8px; font-size:12px; color:var(--muted);
    background:var(--gray-100); border:1px solid var(--border); border-radius:999px; padding:6px 10px;
  }
  .spinner {
    width:12px; height:12px; border:2px solid var(--gray-100); border-top-color:var(--blue);
    border-radius:50%; animation: spin 0.8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .ok    { color:var(--green); }
  .error { color:var(--red); }

  /* Grid */
  .grid {
    display:grid; gap:12px;
    grid-template-columns: repeat(4, minmax(0, 1fr));
  }
  .card {
    position: relative;
    background: var(--card); border:1px solid var(--border);
    border-radius:10px; padding:12px; min-height:90px;
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    text-align:center; font-size:14px;
  }
  .ready{ background:var(--green-100); border-color:var(--green) }
  .blocked{ background:var(--red-100); border-color:var(--red) }
  .unknown{ background:var(--gray-100); border-color:var(--gray) }
  .name{ font-weight:500 }

  /* Tooltip */
  .card[data-missing]:hover::after {
    content: attr(data-missing);
    position: absolute; left: 50%; bottom: calc(100% + 10px); transform: translateX(-50%);
    max-width: 520px; background: #111827; color: #fff; padding: 12px 14px;
    font-size: 13px; line-height: 1.45; border-radius: 10px; white-space: pre-wrap;
    box-shadow: 0 10px 30px rgba(0,0,0,.25); z-index: 20;
  }
  .card[data-missing]:hover::before {
    content: ""; position: absolute; left: 50%; bottom: 100%; transform: translate(-50%, 6px);
    border: 8px solid transparent; border-top-color: #111827;
  }

  /* Buttons */
  .btn { margin-top:8px; padding:4px 12px; font-size:12px; border:none; border-radius:6px; cursor:pointer; font-weight:500 }
  .btn-run { background: var(--blue-100); color: var(--blue); }
  .btn-run:hover { background: var(--blue); color: white; }
  .btn-disabled { background: var(--gray-100); color: var(--muted); cursor: not-allowed; }

  /* Footer */
  footer { margin-top:24px; padding-top:16px }
  .footer-grid { display:grid; gap:16px; grid-template-columns: repeat(3, minmax(0, 1fr)); }
  .section { background:var(--card); border:1px solid var(--border); border-radius:10px; padding:14px }
  .section h3 { margin:0 0 10px; font-size:14px; color:var(--muted); font-weight:600; text-transform:uppercase; letter-spacing:.02em }

  table { width:100%; border-collapse:collapse; font-size:13px }
  th, td { padding:6px 8px; border-bottom: 1px solid var(--border); text-align:left }
  th { color: var(--muted); font-weight:600 }
  .pill { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; background:var(--gray-100); color:var(--muted) }

  @media (max-width: 980px){ .grid{grid-template-columns: repeat(3,1fr)} }
  @media (max-width: 720px){ .grid{grid-template-columns: repeat(2,1fr)} .footer-grid{grid-template-columns:1fr} }
</style>
</head>

<body>
  <header>
    <div>
      <h1>EPIC Controller Dashboard</h1>
      <div class="legend">
        <span class="lg"><span class="dot dot-green"></span>READY</span>
        <span class="lg"><span class="dot dot-red"></span>BLOCKED</span>
        <span class="lg"><span class="dot dot-gray"></span>UNKNOWN</span>
      </div>
    </div>

    <!-- live sync state -->
    <div id="sync" class="sync">
      <span class="spinner" aria-hidden="true"></span>
      <span id="sync-text">Syncing…</span>
    </div>
  </header>

  <!-- Controller Grid -->
  <section id="grid" class="grid"></section>

  <!-- Footer -->
  <footer>
    <div class="footer-grid">
      <!-- SENSORS -->
      <div class="section">
        <h3>SENSORS</h3>
        <table id="sensor-table">
          <thead>
            <tr><th>Device ID</th><th>Type</th><th>Status</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- ACTUATORS -->
      <div class="section">
        <h3>ACTUATORS</h3>
        <table id="motor-table">
          <thead>
            <tr><th>Motor ID</th><th>Type</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- SUMMARY -->
      <div class="section">
        <h3>SUMMARY</h3>
        <table>
          <tbody>
            <tr><td>Jetson Host</td><td><span class="pill" id="sum-host">—</span></td></tr>
            <tr><td>Xsensors</td><td><span class="pill" id="sum-xsens">—</span></td></tr>
            <tr><td>Wi-Fi</td><td><span class="pill" id="sum-wifi">—</span></td></tr>
            <tr><td>Last updated</td><td><span class="pill" id="sum-ts">—</span></td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </footer>

<script>
  const OUTPUT_URL = './data/comparison_output.json';
  const META_URL   = './data/meta.json';
  const INFO_URL   = './data/dash_info.json';
  const REFRESH_MS = 5000;

  // cache-busting to avoid stale fetches
  const bust = url => `${url}?t=${Date.now()}`;

  const statusClass = s => (s === 1 ? 'ready' : s === 0 ? 'blocked' : 'unknown');

  // Keep last snapshots to avoid unnecessary DOM work (prevents flicker)
  let lastCmpStr = '', lastMetaStr = '', lastInfoStr = '';

  function buildCard(name, data) {
    const card = document.createElement('div');
    card.className = `card ${statusClass(data.status)}`;

    if (Array.isArray(data.missing) && data.missing.length) {
      const lines = data.missing.map(m => '• ' + m).join('\n');
      card.setAttribute('data-missing', lines);
    }

    const title = document.createElement('div');
    title.className = 'name';
    title.textContent = name;
    card.appendChild(title);

    const btn = document.createElement('button');
    btn.textContent = 'Run';
    if (data.status === 1) {
      btn.className = 'btn btn-run';
      btn.onclick = () => alert(`(Demo) Would launch: ${name}`);
    } else {
      btn.className = 'btn btn-disabled';
      btn.disabled = true;
    }
    card.appendChild(btn);

    return card;
  }

  async function fetchJSON(url) {
    const res = await fetch(bust(url), { cache: 'no-store' });
    if (!res.ok) throw new Error(`Fetch failed: ${res.status}`);
    return res.json();
  }

  function setSyncState(kind, msg) {
    const badge = document.getElementById('sync');
    const text  = document.getElementById('sync-text');
    badge.querySelector('.spinner').style.display = (kind === 'busy') ? 'inline-block' : 'none';
    badge.classList.remove('ok','error');
    if (kind === 'ok')   badge.classList.add('ok');
    if (kind === 'error')badge.classList.add('error');
    text.textContent = msg;
  }

  async function loadAll() {
    try {
      setSyncState('busy', 'Syncing…');
      const [cmp, meta, info] = await Promise.all([
        fetchJSON(OUTPUT_URL),
        fetchJSON(META_URL),
        fetchJSON(INFO_URL)
      ]);

      // stringify to detect changes
      const cmpStr  = JSON.stringify(cmp);
      const metaStr = JSON.stringify(meta);
      const infoStr = JSON.stringify(info);

      // Grid (only update if changed)
      if (cmpStr !== lastCmpStr) {
        const grid = document.getElementById('grid');
        const frag = document.createDocumentFragment();
        Object.entries(cmp.controllers).forEach(([name, data]) => {
          frag.appendChild(buildCard(name, data));
        });
        grid.replaceChildren(frag);
        lastCmpStr = cmpStr;
      }

      // Sensors (update if changed)
      if (metaStr !== lastMetaStr) {
        const sensorTbody = document.querySelector('#sensor-table tbody');
        sensorTbody.innerHTML = '';
        (meta.IMUs || []).forEach(id => {
          sensorTbody.insertAdjacentHTML('beforeend',
            `<tr><td>${id}</td><td>IMU</td><td><span class="pill">connected</span></td></tr>`);
        });
        if (meta.Xsensors) {
          sensorTbody.insertAdjacentHTML('beforeend',
            `<tr><td>(Xsensor)</td><td>Insole</td><td><span class="pill">connected</span></td></tr>`);
        }

        // Motors
        const motorTbody = document.querySelector('#motor-table tbody');
        motorTbody.innerHTML = '';
        const ids   = meta.Motors?.["motor-id"]    || [];
        const types = meta.Motors?.["motor-types"] || [];
        ids.forEach((id, i) => {
          const type = types[i] || types[0] || '-';
          motorTbody.insertAdjacentHTML('beforeend', `<tr><td>${id}</td><td>${type}</td></tr>`);
        });

        lastMetaStr = metaStr;
      }

      // Summary (update if changed)
      if (infoStr !== lastInfoStr || cmpStr !== lastCmpStr) {
        document.getElementById('sum-host').textContent = info.JetsonHost || '—';
        document.getElementById('sum-wifi').textContent = info.WiFi || '—';
        document.getElementById('sum-xsens').textContent = (meta.Xsensors ? 'ON' : 'OFF');
        document.getElementById('sum-ts').textContent = (cmp.summary && cmp.summary.timestamp) ? cmp.summary.timestamp : '—';
        lastInfoStr = infoStr;
      }

      setSyncState('ok', 'Live');
    } catch (err) {
      console.error('Dashboard update failed:', err);
      setSyncState('error', 'Offline');
    }
  }

  loadAll();
  setInterval(loadAll, REFRESH_MS);
</script>

</body>
</html>